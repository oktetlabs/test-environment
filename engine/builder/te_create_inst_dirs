#! /bin/bash
#
# Test Environment Builder
#
# Script for creation of installation directories
#
#
# Copyright (C) 2004 Test Environment authors (see file AUTHORS in
# the root directory of the distribution).
#
# Test Environment is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of
# the License, or (at your option) any later version.
#
# Test Environment is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston,
# MA  02111-1307  USA
#
#
# Author Elena A. Vengerova <Elena.Vengerova@oktetlabs.ru>
#
# $Id$
#

[ -d $1 ] || mkdir -p $1
pushd $1 >/dev/null
PREFIX=`pwd`
popd >/dev/null

if test -n "${TE_BUILD}" ; then
    cd ${TE_BUILD}
fi

if test -e builder.conf.processed ; then
    . builder.conf.processed
fi

for p in ${2:-${TE_BS_PLATFORMS}} ; do
    libs=${p}_EXT_LIBS
    dir=${p}_EXT_LIBS_DIR

    mkdir -p $PREFIX/$p
    [ -d "$PREFIX/$p/lib" ] && continue

    if [ "${TE_EXT_LIBS}" ] ; then
        mkdir -p "${TE_BUILD}/platforms/$p/lib"
        mkdir -p "${TE_BUILD}/platforms/$p/include"
        pushd "${TE_BUILD}/platforms/$p/" >/dev/null
        for i in ${!libs} ; do
            rm -rf $i.tgz
            wget ${TE_EXT_LIBS}/${!dir}/$i.tgz
            if [ $? -eq 0 ] ; then
                echo "./$p/$i.tgz \\" >>${TE_EXT_LIBS_FILE}
                tar -tzf $i.tgz | xargs -n1 -P0 bash -c \
                    "echo \"./$p/\$0 \\\\\" >>${TE_EXT_LIBS_FILE}"
                tar xzf $i.tgz
            fi
        done
        popd >/dev/null
    fi
done

mkdir -p $PREFIX/agents

exit 0
