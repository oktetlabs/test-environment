#! /bin/sh

if test "$1" == "--ignore-directories"; then
    ignoredir=yes
    shift
elif test "$1" == "--help"; then
    cat <<HELP
USAGE: tce_report [--ignore-directories] <agent-name> <output-file> [<data-directory> <source-directory>]

Processes GCOV data contained in the file "<data-directory>/tce_<agent-name>.tar" 
which should correspond to sources in <source-directory>. Coverage results are put
into <output-file

If <output-file> exists and it matches the current sources, the results are merged
(the older <output-file> is saved as <output-file>.prev)

If <data-directory> is not present, TE_BUILD environment variable is used, in which
case it must contain "builder.conf.processed" that determines the location to sources.

--ignore-directories causes treating the files with the same base name as the same file.
HELP
    exit 1
fi

binaries="`which tce_merge`"
if test -z "$binaries"; then
    mydir=`dirname $0`
    if test -x ${mydir}/tce_merge; then
        export PATH=${mydir}:$PATH
    else
        echo "Supporting scripts not found!!!" >/dev/stderr
        exit 1
    fi
fi

tce_taname=$1 
mergefile=$2
outfile=${mergefile}.new
if test -n "$3"; then
    TE_BUILD=$3
    NUT_SOURCES=$4
elif test -e ${TE_BUILD}/builder.conf.processed ; then
    . ${TE_BUILD}/builder.conf.processed
    NUT=`eval echo '$TCE_TANAME_'$tce_taname'_NUT'`
    if test -n "$NUT"; then
        NUT_SOURCES=`eval echo '$NUT_'$NUT'_SOURCES'` 
    fi
fi    

if test -n "$NUT_SOURCES"; then
    echo "*** Test coverage report for $tce_taname:" >$outfile
    echo "*** Sources are at $NUT_SOURCES:" >>$outfile
    find $NUT_SOURCES -follow \( -name '*.gcov' -o -name '*.da' \) -exec rm -f '{}' ';'
        tar -x -P -f ${TE_BUILD}/tce_${tce_taname}.tar
        find $NUT_SOURCES -follow \( -name '*.da' -o -name '.[a-z]*.da' \) -exec tce_gcov '{}' ';' && 
            (
                if test -n "$ignoredir" -a ! -f "$mergefile"; then
                    auxfile=${mergefile}.aux
                    find $NUT_SOURCES -follow -name '*.gcov' -exec tce_merge "" '{}' true ';' >$auxfile
                    find $NUT_SOURCES -follow -name '*.gcov' -exec tce_merge $auxfile '{}' true ';' >>$outfile
                    rm -f $auxfile
                else
                    find $NUT_SOURCES -follow -name '*.gcov' -exec tce_merge $mergefile '{}' $ignoredir ';' >>$outfile
                fi
            ) 
        echo >>$outfile
        tce_count $outfile '^branch[[:space:]]*[0-9]+ never executed' '^branch[[:space:]]*[0-9]+ taken' | 
        (
            read ratio sum
            echo "*** Grand Total: $ratio% of $sum branches covered" >>$outfile
        )
        tce_count $outfile '^[[:space:]]*#+:' '^[[:space:]]*[0-9]+:' |
        (
            read ratio sum
            echo "*** Grand Total: $ratio% of $sum lines covered" >>$outfile
        )
        if test -f $mergefile; then
            mv -f $mergefile $mergefile.prev
        fi
        mv -f $outfile $mergefile
else
    echo "No sources specified!!!!" >/dev/stderr
    exit 1
fi        





