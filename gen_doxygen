#!/bin/bash
#
# doxygen filter can expect the following environment variables are set:
# - DOWNLOAD_DOC_LINK - path to TAR.GZ packed documentation file.
#                       If this variable is set, then "Download"
#                       section will be added to the documentation mainpage.
# - DOXYREST_PREFIX   - prefix path to doxyrest if you want to use sphinx to
#                       generate HTML
#

help() {
    cat <<EOF
This is a wrapper script which builds the autogenerated part of the 
Test Environment documentation.

Usage:
  $ gen_doxygen [--type=<doxygen|sphinx>] [-h|--help]

--type:
  doxygen           - Use doxygen to generate HTML
  sphinx            - Use sphinx to generate HTML

Documentation will be located at doc/generated/html/
EOF
    exit 0
}

DOC_TYPE="doxygen"
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help) help;;
        --type=*) DOC_TYPE="${1#*=}"; shift;;
    esac
done

function generate_doxygen_doc()
{
    doxygen > /dev/null
    ./doc/dox_resources/tableofcontents
}

function generate_sphinx_doc()
{
    if [ -z "$DOXYREST_PREFIX" ]; then
        echo "Please set DOXYREST_PREFIX before:"
        echo "Last release: https://github.com/vovkos/doxyrest/releases"
        exit -1
    fi
    [ -z "$DOXYREST_BIN" ] && DOXYREST_BIN="$DOXYREST_PREFIX/bin/doxyrest"

    [ -z "$SPHINX_BUILD_BIN" ] && SPHINX_BUILD_BIN="sphinx-build"
    if ! which $SPHINX_BUILD_BIN >/dev/null; then
        echo "Please install sphinx before:"
        echo " $ pip install sphinx"
        exit -2
    fi

    ( cat Doxyfile ;
      echo "GENERATE_XML=YES" ;
      echo "GENERATE_HTML=NO" ) | doxygen - > /dev/null

    DOXYREST_OPTS=(
      --config=doc/doxyrest-config.lua
      --frame-dir=$DOXYREST_PREFIX/share/doxyrest/frame/cfamily
      --frame-dir=$DOXYREST_PREFIX/share/doxyrest/frame/common
    )

    ${DOXYREST_BIN} "${DOXYREST_OPTS[@]}" > /dev/null || exit 1
    find doc/generated/xml -name "*.png" -exec cp {} doc/generated/rst \;

    SPHINX_BUILD_OPTS=(
      -j auto             # use cpu count
      -q                  # be quite: warn and error only
      -c doc              # where store conf.py
      doc/generated/rst   # input
      doc/generated/html  # output
    )

    ${SPHINX_BUILD_BIN} "${SPHINX_BUILD_OPTS[@]}"
}

case $DOC_TYPE in
    doxygen) generate_doxygen_doc;;
    sphinx) generate_sphinx_doc;;
    *) echo "What is '$DOC_TYPE'?"; help;;
esac

echo "" >&2
echo "###########################################" >&2
echo "## See doc/generated/html/index.html ######" >&2
echo "###########################################" >&2
