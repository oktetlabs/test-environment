ID OKTL-0000036

COPYRIGHT Copyright(C) OKTET Labs 2004

RESPMGR Elena Vengerova mailto:helen@oktetlabs.ru

SOURCES
svn://test-environment/trunk/lib/rcfpch
    rcf_pch.h
    rcf_ch_api.h
    rcf_pch_internal.h
    rcf_pch.c
    rcf_pch_file.c
    rcf_pch_var.c
    rcf_pch_conf.c
Revision 678

COMPLY
OKTL-0000034

MODERATOR Andrew Rybchenko mailto:arybchik@oktetlabs.ru


DEFECT STYLE STATUS FIXED
configure.ac:5:Fix E-mail address

DEFECT STYLE STATUS FIXED
configure.ac:11: Use -Wall option.

OPINION AUTHOR arybchik STYLE STATUS FIXED
configure.ac:11: Use foreign option here. Remove it from Makefile.am.

DEFECT QUESTION STATUS FIXED
configure.ac:18-21: I'm not sure that all these tools are required.

DEFECT QUESTION STATUS FIXED
configure.ac:34: Not all used headers are listed:
stdio.h, ctype.h, sys/types.h, stdlib.h, sys/stat.h, unistd.h, time.h,
dirent.h, sys/time.h, string.h, strings.h, fcntl.h


DEFECT STYLE STATUS FIXED
Makefile.am:4: Use AM_CPPFLAGS to define preprocessor -I flags

DEFECT STYLE STATUS FIXED
Makefile.am:4,6: Do not include TE_*FLAGS in AM_*FLAGS, since
TE_*FLAGS are already included in *FLAGS in configure.ac.


DEFECT STYLE
GENERAL line 2
It seems useless from Doxygen point of view to state project
name in @brief clause. Module name should be there.
E.g: RCF Portable Command Handler


OPINION AUTHOR arybchik STYLE
There are many prototypes of functions are defined in PCH and CH headers.
I think that order of arguments should be the same in all. The first should
be mandatory arguments, then optional - generic, then specific:
1. handle
2. cbuf
3. buflen
4. answer_plen
5. ba (?)
6. cmdlen (?)
...


DEFECT STYLE STATUS FIXED
rcf_pch.h:5: Typo "Handles" -> "Handlers"

DEFECT STYLE STATUS FIXED
rcf_pch.h: 'te_stdint.h' should be included from this header since
uint32_t and uint64_t types are used here.
'te_defs.h' should also be included, since boolean type will be used.
Headers with definitions of used enumerations should also be included.

DEFECT STYLE STATUS FIXED
rcf_pch.h:43: 'const' qualifier should be used
rcf_pch.c:299

DEFECT STYLE STATUS FIXED
rcf_pch.h:37: It should be stated in description that function blocks
caller until shutdown, all commands are processed inside the function.

OPINION AUTHOR arybchik STYLE STATUS FIXED
rcf_pch.h:43: Name of the function is not so good. It does not reflect
stated above notes. I suggest something like 'rcf_pch_run'.

DEFECT STYLE STATUS FIXED
rcf_pch.h:general: Why are 'default' command handlers are necessary in
external interface? May be it's sufficient to use them from
'rcf_pch_start_pch'. Necessity should be explained in functions
descriptions.

DEFECT QUESTION STATUS FIXED
rcf_pch.h:59,77: May enum be used for 'type' variable instead of 'int'.
rcf_pch_var.c:44,182
rcf_pch.c:104,171

DEFECT STYLE STATUS FIXED
rcf_pch.h:59,77: 'const' qualifier should be used for 'var' parameter.
rcf_pch_var.c:44,182

DEFECT STYLE STATUS FIXED
rcf_ch_api.h:general
rcf_pch.c:272,274
rcf_pch.h:57,58,75,77,98,100,119,121,140,142: standard 'size_t' type should
be used for variables with length semantic (buflen, answer_plen, cmdlen).

DEFECT STYLE STATUS FIXED
rcf_pch.h:70,71,78: Such approach is very bad for future extensions,
it seems better to use vararg's.

DEFECT QUESTION STATUS FIXED
rcf_pch.h:100: Why 'int' type is used for 'op' parameter?
May corresponding enum be used?

DEFECT STYLE STATUS FIXED
rcf_pch.h:100,121,142: 'const' qualifier should be used for 'oid', 'val',
'filename', 'rtn' parameters.

DEFECT STYLE STATUS FIXED
rcf_pch.h:121; Boolean type should be used for 'put' parameter.

DEFECT STYLE STATUS FIXED
rcf_pch.h:134,142: It's very bad name in accordance with common meaning
of the 'argv' parameter. Moreover 'int' type is inappropriate here.
It should be boolean type or enumeration.
rcf_pch.c:143

OPINION AUTHOR arybchik STATUS FIXED
rcf_pch.h:rcf_pch_call: It's better to change arguments order:
'rtn', 'type_of_protorype(argv)', 'argc', 'params'.


DEFECT STYLE STATUS FIXED
rcf_pch_internal.h:31-33: It should be located after includes.
rcf_ch_api.h:32-34

DEFECT STYLE STATUS FIXED
rcf_pch_internal.h:86: SKIP_SPACES is better name for such macro.

DEFECT MINOR STATUS FIXED
rcf_pch_internal.h:87: Macro parameters should be enclosed in parenthesis
when used in macro expressions.

DEFECT MINOR STATUS FIXED
rcf_pch_internal.h:87: Excessive check for *_ptr != 0, since it's always
true, if *_ptr == ' '.

DEFECT STYLE STATUS FIXED
rcf_pch_internal.h:115: Bad English. It's hard to understand this sentence.

DEFECT STYLE STATUS FIXED
rcf_pch_internal.h:122: 'const' qualifier should be used for 's' parameter.

DEFECT STYLE STATUS FIXED
rcf_pch_internal.h:122:  standard 'size_t' type should be used for 'len'
parameter.

DEFECT QUESTION STATUS FIXED
rcf_pch_internal.h:143,144: Why are standard functions prototypes defined
here? May be appropriate headers should be included? If header does not
provided some functions under some compilation conditions, these prototypes
should be declared in that circumstance only and comment with explanations
should be provided.


OPINION AUTHOR arybchik STYLE STATUS FIXED
rcf_pch.c:31: RCF_NEED_TYPES should be undefined after include

DEFECT STYLE STATUS FIXED
rcf_pch.c:35,36: #if 0 should be used here, or just remove this code

OPINION AUTHOR arybchik STYLE TODO
rcf_pch.c:43: Bad English - "instead of ..."
I don't understand the description at all.

DEFECT STYLE STATUS FIXED
rcf_pch.c:50: @retval should be used for each retrun value instead of
@return with such description.
rcf_pch.c:216

DEFECT STYLE STATUS FIXED
rcf_pch.c:57: Boolean type should be used for 'quotes' variable.

DEFECT MINOR TODO
rcf_pch.c:82: It's impossible to have \0 in 'p' here, since it's not
shifted after 'while' condition except when it's shifted to have " or \
in line 73.
Insert appropriate validation after exit from while loop.

DEFECT STYLE STATUS FIXED
rcf_pch.c:88: Use READ_SPACES here.

DEFECT STYLE STATUS FIXED
rcf_pch.c:102,111,114,177: "RCF_STRING + 1" may be a valid type in future,
define special type to be considered as invalid and use it.

DEFECT STYLE STATUS FIXED
rcf_pch.c:116: RCF_INT8 and RCF_STRING should not be used as min and max
numbers of types, define appropriate macros and use them.

DEFECT STYLE STATUS FIXED
rcf_pch.c:142: This function is not used outside of the file and should be
declared with 'static' qualifier.

DEFECT STYLE STATUS FIXED
rcf_pch.c:174: Hardcoded constant

DEFECT QUESTION STATUS FIXED
rcf_pch.c:219: May enumeration be used for opcodes?

DEFECT STYLE STATUS FIXED
rcf_pch.c:219: Use 'const' qualifier in 'ptr' parameter type declaration
(It seems it should be "char const **ptr").

DEFECT STYLE STATUS FIXED
rcf_pch.c:278:snprintf() should be used and buffer length should be passed
as parameter in function.

DEFECT STYLE STATUS FIXED
rcf_pch.c:305: Use boolean type for 'pending' variable.

DEFECT STYLE STATUS FIXED
rcf_pch.c:310, 322: Empty line should divide variable declarations and code.

DEFECT STYLE STATUS FIXED
rcf_pch.c:330: Remove space before ;

DEFECT MINOR STATUS FIXED
rcf_pch.c:323: Use snprintf() with verification of return value

OPINION AUTHOR arybchik TODO
rcf_pch.c:344: It's critical (not usual) situation and LOGS_DEBUG should be
used.

OPINION AUTHOR arybchik STYLE TODO
rcf_pch.c:rcf_pch_start_pch: Communication problems are not rare and
'console logging' should be used instead of TE logging. We need console
logging MACROs, I think.

DEFECT QUESTION TODO
rcf_pch.c:438,440: It seems 'if' from 440 line may be put after 'else' in
438 line. Also 'ptr != 0' should be used instead of 'ba == NULL' in line
440. In any case processing is not clear and rules should be explained in
comments.

DEFECT STYLE STATUS FIXED
rcf_pch.c:519: 'else' should be on its own line

DEFECT QUESTION TODO
rcf_pch.c:689-701: It seems "postponedresults" string will be accepted.
Is it OK?


DEFECT MINOR STATUS FIXED
rcf_pch_file.c:69: May return NULL -> incorrect processing

DEFECT STYLE STATUS FIXED
rcf_pch_file.c:80: strtol is executed in any case and it's better to locate
it before 'if'.

DEFECT MAJOR STATUS FIXED
rcf_pch_file.c:134:Substitution in filename should be done in any case.
'memcpy' may be used instead of 'strncpy' since 'memcpy' is faster, when
exact number of characters is known.

DEFECT QUESTION TODO
rcf_pch_file.c:GENARAL: Should rcf_comm_agent_wait() be called under lock?
(rcf_ch_(un)lock).

DEFECT STYLE STATUS FIXED
rcf_pch_file.c:224,226: Empty line should be between variables declaration
and code.


OPINION AUTHOR arybchik STYLE STATUS REJECTED
rcf_pch_var.c:58: It's better to use time() instead of gettimeofday(), if
seconds are used only.

OPINION AUTHOR arybchik STYLE STATUS REJECTED
rcf_pch_var.c:59: It's better to use GMT instead of local time.

DEFECT MINOR STATUS FIXED
rcf_pch_var.c:80: It should be logged that variable was trunkated.

DEFECT STYLE STATUS FIXED
rcf_pch_var.c:general: Empty line should be between variables declaration
and code.

DEFECT STYLE STATUS FIXED
rcf_pch_var.c:rcf_pch_vread,163: In the case of unknown type zero is returned
and reply is not sent. assert() should be used to ensure that it'll not
happen because of rejenct on earlier stage of request processing.

DEFECT STYLE STATUS FIXED
rcf_pch_var.c:596: Zero should not be printed, it should be a part of format
string.


DEFECT STYLE STATUS FIXED
rcf_ch_api.h:46: Doxygen-style comment should be used.

DEFECT STYLE STATUS FIXED
rcf_ch_api.h:606: Incorrect comment.


DEFECT MINOR TODO
rcf_pch_conf.c:general: Common for TA and TEN sides library with well
defined interface should be used for OID parsing/validation in order
to concentrate all extensions to OID syntax in this library without
duplication of code.

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:4: Incorrect comment

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:31: Incorrect comment style (non-Doxygen)

DEFECT QUESTION STATUS FIXED
rcf_pch_conf.c:41: What is "object of object instance identifier"?

DEFECT STYLE TODO
rcf_pch_conf.c:55: It's better to divide the function into two parts: one
for object ID parse, another for instance OID parse; since there is no
common code in accordance with impelementation.

DEFECT MINOR TODO
rcf_pch_conf.c:77: It should be done under "else" statement, since it's
already equal to \0 in "if" branch.

DEFECT MINOR STATUS FIXED
rcf_pch_conf.c:96,121,134: Memory allocated for sub_id should be freed here.

DEFECT QUESTION STATUS FIXED
rcf_pch_conf.c:130,133: It seems oid is equal to "*" here. Why is 'oid' used
in strdup().

DEFECT MINOR STATUS FIXED
rcf_pch_conf.c:177,329: while() condition should be divided into
if ((_rc) != 0) while (...), since _rc is not modified in while loop body.

DEFECT QUESTION TODO
rcf_pch_conf.c:209: Why is string with one space used here?

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:240,241: Remove space before ;

DEFECT MINOR STATUS FIXED
rcf_pch_conf.c:415: strdup() may return NULL, it's necessary to verify and
return ENOMEM.

DEFECT MINOR STATUS FIXED
rcf_pch_conf.c:437-438: May be written without usage of strlen() as:
    ptr += sprintf(ptr, "%s ", list->oid);
   
DEFECT MINOR STATUS FIXED
rcf_pch_conf.c:480: Use snprintf().

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:481-491: Rearange code:
    rcf_ch_lock();
    rc = rcf_comm_agent_reply(conn, cbuf, strlen(cbuf) + 1);
    if (rc == 0)
    {
        rc = rcf_comm_agent_reply(conn, tmp, strlen(tmp) + 1);
    }
    rcf_ch_unlock();
    free(tmp);

OPINION AUTHOR arybchik MINOR STATUS FIXED
rcf_pch_conf.c:518,554: It seems there is not real performance advantage of
using static vairable here, since rcf_ch_conf_root() will usually return
pointer to TA variable. However, usage of static variable introduce many
questions about thread-safety etc.

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:543: it's necesary to emphasys here, that !default!
configuration handler is executed.

OPINION AUTHOR arybchik STYLE STATUS FIXED
rcf_pch_conf.c:564: It's better to use "for" loop here with initialization
from lines 554 and 557 (obj = rcf_ch_conf_root()), check combined from lines
554 and 597 (obj != NULL), next expression from line 597 (obj = obj->son).
At exit it's necessary to report SEND_ANSWER("%d", ETENOSUCHNAME), if 
obj == NULL.

OPINION AUTHOR arybchik STYLE STATUS FIXED
rcf_pch_conf.c:general: TE logging should be used everywhere when incorrect
command (OID) is encountered using LOGS_DEBUG() macro, since it's abnormal
situation. E.g: 562, 569, 577, 585. In order to easily discover incorrect
input as well as processing failures.

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:587: sizeof(inst_names[0]) should be used instead of
sizeof(char *).

OPINION AUTHOR arybchik STYLE STATUS FIXED
rcf_pch_conf.c:605: It's better to use "" for empty string initialization.

DEFECT STYLE STATUS FIXED
rcf_pch_conf.c:601: Default case should be provided with assert().


RESULT
No additional review is required.
