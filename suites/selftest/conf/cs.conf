---
- include:
   - cm_process.yml
   - cm_vm.yml
   - cm_base.yml
   - cm_volatile.yml

# TAPI cache
- register:
    - oid: "/volatile/cache/foo"
      access: read_create
    - oid: "/volatile/cache/foo/bar"
      access: read_create
    - oid: "/volatile/cache/foo/bar/baz"
      access: read_create
      type: string
    - oid: "/volatile/cache/foo/bar/qux"
      access: read_create
      type: string
    - oid: "/volatile/cache/foo/bar/quux"
      access: read_create
      type: integer
    - oid: "/volatile/cache/foo/bar/quuz"
      access: read_create
      type: string
    - oid: "/volatile/cache/foo/bar/corge"
      access: read_create
      type: address
    - oid: "/volatile/cache/foo/baz"
      access: read_create
      type: string
    - oid: "/volatile/cache/foo/qux"
      access: read_create
      type: string
    - oid: "/volatile/cache/foo1/"
      access: read_create
    - oid: "/volatile/cache/foo1/baz"
      access: read_create
      type: string

# nginx support
- register:
    - oid: /agent/nginx
      access: read_create
      type: none
    - oid: /agent/nginx/status
      access: read_write
      type: integer
    - oid: /agent/nginx/cmd_prefix
      access: read_write
      type: string
    - oid: /agent/nginx/config_path
      access: read_only
      type: string
    - oid: /agent/nginx/error_log
      access: read_write
      type: integer
    - oid: /agent/nginx/error_log/path
      access: read_only
      type: string
    - oid: /agent/nginx/worker
      access: read_only
      type: none
    - oid: /agent/nginx/worker/processes
      access: read_write
      type: integer
    - oid: /agent/nginx/worker/cpu_affinity
      access: read_only
      type: none
    - oid: /agent/nginx/worker/cpu_affinity/mode
      access: read_write
      type: integer
    - oid: /agent/nginx/worker/cpu_affinity/mask
      access: read_write
      type: string
    - oid: /agent/nginx/worker/rlimit_nofile
      access: read_write
      type: integer
    - oid: /agent/nginx/events
      access: read_only
      type: none
    - oid: /agent/nginx/events/worker_connections
      access: read_write
      type: integer
    - oid: /agent/nginx/events/method
      access: read_write
      type: string
    - oid: /agent/nginx/events/multi_accept
      access: read_write
      type: integer
    - oid: /agent/nginx/events/accept_mutex
      access: read_write
      type: integer
    - oid: /agent/nginx/http
      access: read_only
      type: none
    - oid: /agent/nginx/http/server
      access: read_create
      type: none
    - oid: /agent/nginx/http/server/access_log
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/access_log/path
      access: read_only
      type: string
    - oid: /agent/nginx/http/server/listen
      access: read_create
      type: string
    - oid: /agent/nginx/http/server/listen/reuseport
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/listen/ssl
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/hostname
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/mime_type
      access: read_only
      type: none
    - oid: /agent/nginx/http/server/mime_type/default
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/proxy
      access: read_only
      type: none
    - oid: /agent/nginx/http/server/proxy/connect_timeout
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/proxy/buffering
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/proxy/buffering/num
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/proxy/buffering/def_size
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/proxy/buffering/init_size
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/open_file_cache
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/open_file_cache/max
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/open_file_cache/inactive
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/open_file_cache/valid
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/open_file_cache/errors
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client
      access: read_only
      type: none
    - oid: /agent/nginx/http/server/client/body_timeout
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client/max_body_size
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client/header_timeout
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client/header_buffer_size
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client/large_header_buffer
      access: read_only
      type: none
    - oid: /agent/nginx/http/server/client/large_header_buffer/num
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client/large_header_buffer/size
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/client/proxy_request_buffering
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/sendfile
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/tcp_nopush
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/tcp_nodelay
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/send_timeout
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/reset_timedout_connection
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/keepalive_timeout
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/keepalive_requests
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/tokens
      access: read_write
      type: integer
    - oid: /agent/nginx/http/server/ssl_name
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location
      access: read_create
      type: none
    - oid: /agent/nginx/http/server/location/uri
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/return
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/index
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/root
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/ssl_name
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/proxy
      access: read_only
      type: none
    - oid: /agent/nginx/http/server/location/proxy/ssl_name
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/proxy/pass_url
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/proxy/http_version
      access: read_write
      type: string
    - oid: /agent/nginx/http/server/location/proxy/set_header
      access: read_create
      type: string
    - oid: /agent/nginx/http/server/location/proxy/set_header/value
      access: read_write
      type: string
    - oid: /agent/nginx/http/upstream
      access: read_create
      type: none
    - oid: /agent/nginx/http/upstream/server
      access: read_create
      type: string
    - oid: /agent/nginx/http/upstream/server/weight
      access: read_write
      type: integer
    - oid: /agent/nginx/http/upstream/keepalive
      access: read_write
      type: integer
    - oid: /agent/nginx/ssl
      access: read_create
      type: none
    - oid: /agent/nginx/ssl/cert
      access: read_write
      type: string
    - oid: /agent/nginx/ssl/key
      access: read_write
      type: string
    - oid: /agent/nginx/ssl/ciphers
      access: read_write
      type: string
    - oid: /agent/nginx/ssl/protocols
      access: read_write
      type: string
    - oid: /agent/nginx/ssl/session
      access: read_only
      type: none
    - oid: /agent/nginx/ssl/session/cache
      access: read_write
      type: string
    - oid: /agent/nginx/ssl/session/timeout
      access: read_write
      type: integer

# UPnP objects
- register:
    - oid: "/agent/upnp_cp"
      access: read_only
      type: string
    - oid: "/agent/upnp_cp/enable"
      access: read_write
      type: integer
    - oid: "/agent/upnp_cp/target"
      access: read_write
      type: string
    - oid: "/agent/upnp_cp/iface"
      access: read_write
      type: string

- register:
    - oid: "/local"

- register:
    - oid: "/local/vm"
      access: read_create
      type: none
    - oid: "/local/vm/kvm"
      access: read_write
      type: integer
    - oid: "/local/vm/cpu"
      access: read_only
      type: none
    - oid: "/local/vm/cpu/model"
      access: read_write
      type: string
    - oid: "/local/vm/cpu/num"
      access: read_write
      type: integer
    - oid: "/local/vm/mem"
      access: read_only
      type: none
    - oid: "/local/vm/mem/size"
      access: read_write
      type: integer
    - oid: "/local/vm/drive"
      access: read_create
      type: none
    - oid: "/local/vm/drive/file"
      access: read_write
      type: string
    - oid: "/local/vm/drive/snapshot"
      access: read_write
      type: integer
    - oid: "/local/vm/drive/cdrom"
      access: read_write
      type: integer
    - oid: "/local/vm/serial"
      access: read_write
      type: string

- register:
    - oid: "/local/no_reuse_pco"
      access: read_write
      type: integer
      volatile: true

- register:
    - oid: "/net"
      access: read_create
    - oid: "/net/ip4_subnet"
      access: read_create
      type: address
    - oid: "/net/ip6_subnet"
      access: read_create
      type: address
    - oid: "/net/node"
      access: read_create
      type: string
    - oid: "/net/node/type"
      access: read_write
      type: integer
    - oid: "/net/node/ip4_address"
      access: read_create
      type: address
    - oid: "/net/node/ip6_address"
      access: read_create
      type: address

- register:
    - oid: "/net_pool"
      access: read_create
    - oid: "/net_pool/entry"
      access: read_create
      type: integer
    - oid: "/net_pool/entry/prefix"
      access: read_write
      type: integer
    - oid: "/net_pool/entry/n_entries"
      access: read_write
      type: integer
    - oid: "/net_pool/entry/pool"
      access: read_write
    - oid: "/net_pool/entry/pool/entry"
      access: read_create
      type: integer

- add:
    - oid: "/net_pool:ip4"
    - oid: "/net_pool:ip4/entry:10.38.10.0"
      value: 0

- set:
    - oid: "/net_pool:ip4/entry:10.38.10.0/prefix:"
      value: 24

- add:
    - oid: "/net:net1"

- cond:
    if: |
        ${TE_AGT1_TA_NAME} != "" &
        ${TE_AGT1_TA_IF} != ""
    then:
        - add:
            - oid: "/net:net1/node:A"
              value: "/agent:${TE_AGT1_TA_NAME}/interface:${TE_AGT1_TA_IF}"
        - set:
            - oid: "/net:net1/node:A/type:"
              value: 1
        - add:
            - oid: "/agent:${TE_AGT1_TA_NAME}/rsrc:${TE_AGT1_TA_IF}"
              value: /agent:${TE_AGT1_TA_NAME}/interface:${TE_AGT1_TA_IF}

- cond:
    if: |
        ${TE_AGT2_TA_NAME} != "" &
        ${TE_AGT2_TA_IF} != ""
    then:
        - add:
            - oid: "/net:net1/node:B"
              value: "/agent:${TE_AGT2_TA_NAME}/interface:${TE_AGT2_TA_IF}"
        - set:
            - oid: "/net:net1/node:B/type:"
              value: 0
        - add:
            - oid: "/agent:${TE_AGT2_TA_NAME}/rsrc:${TE_AGT2_TA_IF}"
              value: /agent:${TE_AGT2_TA_NAME}/interface:${TE_AGT2_TA_IF}

- add:
    - oid: "/local:"
    - oid: "/local:/vm:testvm"
    - oid: "/local:/vm:testvm/drive:root"

- set:
    - oid: "/local:/vm:testvm/kvm:"
      value: 1
    - oid: "/local:/vm:testvm/cpu:/model:"
      value: ${TE_VM_CPU_MODEL:-host}
    - oid: "/local:/vm:testvm/mem:/size:"
      value: 1024
    - oid: "/local:/vm:testvm/drive:root/file:"
      value: "/srv/virtual/deb10.qcow2"
    - oid: "/local:/vm:testvm/drive:root/snapshot:"
      value: 1
    - oid: "/local:/vm:testvm/serial:"
      value: ""

- add:
    - oid: "/volatile:"
    - oid: "/volatile:/cache:"

- set:
    - oid: "/volatile:/alien_link_addr:"
      value: "${TE_ALIEN_LINK_ADDR:-00:10:29:38:47:56}"
