#! /usr/bin/awk -f

# This script extracts comments from a `package.xml' file and converts them
# to the form suitable for Doxygen processing

function process(str)
{
    if (sub(/-->.*/, " ", str))
        in_dox_comment = 0;
    else
        in_dox_comment = 1;

    if (sub(/@page/, str)) {
        if (in_page) {
            if (run_found) {
                print ""
                printf("RUN NAME: %s\n", run_name);
            }
            print "*/";
        }

        print "/**";
        in_page = 1;

        run_found = 0;
    }

    print str;

    return;
}

in_dox_comment && /^[[:space:]]*\*/ { sub(/^[[:space:]]*\*/, ""); }

/<!---/ {   n = split($0, arr, /<!--- /);
            if (in_dox_comment)
                process(arr[1]);
            in_dox_comment = 1;
            for (i = 2; i <= n; i++)
                process(arr[i]);

            next;
        }

in_dox_comment && /-->/ {   sub(/.*-->.*/, "\n");
                            if ($0) print;
                            in_dox_comment = 0;
                            next;
                        }

in_dox_comment { print $0; next }

/<enum name/ {
  sub(/.*<enum/, "\nName: ");
  sub(/ name="/, "");
  sub(/">/, "\n\nValues: \n");

  in_enum = 1;

  print $0;
  next;
}

in_enum && /<value/ {
  sub(/<\/value>/, ",");
}

in_enum && /req=/ {
  sub(/.*req="/, "-# (req=");
  sub(/">/, ") ");
  print $0;
  next;
}

in_enum && /<value/ {
  sub(/.*>/, "-# ");
  print $0;
  next;
}

/<\/enum>/ {
  sub(/<\/enum>/, "");

  in_enum = 0;
  print $0;
  next;
}

/<run name/ {
    if (in_page && ! run_logged) {
        run_name = $0
        gsub(" .*<run name=\"", "", run_name);
        gsub("\".*>", "", run_name);
        run_found = 1;
    }
}

in_run && /<\/run>/ {
    in_run = 0;
}

END { print "*/"; }
